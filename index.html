<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Casa Manager v4.2 - Modern</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <style>
        :root { 
            --primary: #4285f4; 
            --bg: #f0f2f5; 
            --card: #ffffff; 
            --text: #1f1f1f; 
            --border: #e0e0e0; 
            --accent: #fbbc04; 
            --danger: #ea4335; 
            --success: #34a853; 
            --shadow: 0 4px 15px rgba(0,0,0,0.05);
        }
        
        body { 
            font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
            margin: 0; 
            padding-bottom: 90px; 
            background: var(--bg); 
            color: var(--text);
            line-height: 1.4;
        }

        header { 
            padding: 20px 15px; 
            background: white; 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            position: sticky; 
            top: 0; 
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.03);
        }

        header h1 { margin: 0; font-size: 18px; color: var(--primary); letter-spacing: 1px; }

        .page { display: none; padding: 15px; animation: fadeIn 0.3s ease; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Card Style */
        .card { 
            background: var(--card); 
            border: none; 
            border-radius: 20px; 
            padding: 18px; 
            margin-bottom: 20px; 
            box-shadow: var(--shadow);
        }

        /* Calendar */
        .calendar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
        .day-box { 
            background: white; 
            border-radius: 20px; 
            padding: 12px; 
            box-shadow: var(--shadow);
            border: 2px solid transparent;
            transition: all 0.2s ease;
        }
        .day-box.today { border-color: var(--primary); background: #f8fbff; }
        
        .day-title { font-size: 13px; font-weight: 800; color: #5f6368; margin-bottom: 8px; text-transform: uppercase; }

        .meal-row { margin-bottom: 12px; position: relative; }
        .meal-label { font-size: 10px; font-weight: bold; margin-bottom: 4px; display: flex; align-items: center; gap: 4px; }
        .label-p { color: #f29900; }
        .label-c { color: #1a73e8; }

        select { 
            width: 100%; 
            padding: 8px 10px; 
            border: 1px solid #eee; 
            border-radius: 12px; 
            font-size: 14px; 
            background: #f8f9fa;
            appearance: none;
        }

        /* Bottoni */
        button { 
            border: none; 
            border-radius: 12px; 
            font-weight: bold; 
            cursor: pointer; 
            transition: transform 0.1s active;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        button:active { transform: scale(0.95); }

        .btn-main { background: var(--primary); color: white; width: 100%; padding: 14px; font-size: 16px; margin-top: 10px; }
        
        .btn-cook { 
            position: absolute; right: 4px; top: 18px; 
            background: var(--accent); color: white; 
            border-radius: 50%; width: 28px; height: 28px; 
            box-shadow: 0 2px 5px rgba(0,0,0,0.2);
            font-size: 14px; border: 2px solid white;
        }

        .btn-buy { 
            background: var(--success); color: white; 
            padding: 8px 16px; border-radius: 50px; 
            font-size: 12px; letter-spacing: 0.5px;
        }

        /* Liste */
        .item-row { 
            display: flex; justify-content: space-between; 
            align-items: center; padding: 12px 0; 
            border-bottom: 1px solid #f0f0f0; 
        }
        .item-row:last-child { border: none; }

        .clickable-item { 
            padding: 15px; background: white; 
            border-radius: 15px; margin-bottom: 8px; 
            display: flex; justify-content: space-between; 
            align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.02);
            border: 1px solid #f1f1f1;
        }

        .badge { 
            background: #e8f0fe; color: var(--primary); 
            padding: 4px 10px; border-radius: 10px; 
            font-size: 13px; font-weight: bold; 
        }

        /* Tab Bar */
        .tab-bar { 
            position: fixed; bottom: 0; width: 100%; 
            background: rgba(255,255,255,0.95); 
            backdrop-filter: blur(10px);
            display: flex; border-top: 1px solid var(--border); 
            padding-bottom: env(safe-area-inset-bottom);
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
        }
        .tab-btn { 
            flex: 1; padding: 18px 0; border: none; 
            background: none; font-size: 10px; color: #80868b; 
            font-weight: bold; text-transform: uppercase;
        }
        .tab-btn.active { color: var(--primary); position: relative; }
        .tab-btn.active::after { 
            content: ''; position: absolute; top: 0; left: 20%; 
            width: 60%; height: 3px; background: var(--primary); 
            border-radius: 0 0 10px 10px;
        }

        /* Auth */
        #login-page { padding: 30px; display: flex; align-items: center; justify-content: center; height: 80vh; }
        .auth-card input { 
            width: 100%; padding: 15px; margin-bottom: 10px; 
            border: 1px solid var(--border); border-radius: 12px; 
            box-sizing: border-box; font-size: 16px;
        }
    </style>
</head>
<body>

<div id="login-page">
    <div class="auth-card" style="width:100%; max-width:350px;">
        <h1 style="text-align:center; color:var(--primary); margin-bottom:30px;">CASA MANAGER</h1>
        <input type="email" id="email" placeholder="Email">
        <input type="password" id="password" placeholder="Password">
        <button class="btn-main" onclick="handleLogin()">ACCEDI</button>
    </div>
</div>

<div id="app-content" style="display:none;">
    <header>
        <h1>CASA MANAGER 4.2</h1>
        <button onclick="handleLogout()" style="background:none; color:var(--danger); font-size:12px;">LOGOUT</button>
    </header>

    <div id="home" class="page active">
        <div class="calendar-grid" id="settimana"></div>
        <h4 style="margin:25px 0 10px 5px; color:#5f6368;">üõí DA COMPRARE</h4>
        <div class="card" id="listaSpesa"></div>
    </div>

    <div id="dispensa" class="page">
        <h3 id="disp-title" style="margin-left:5px;">üì¶ Dispensa</h3>
        <div class="card">
            <input type="text" id="pNome" placeholder="Cosa hai comprato?" style="width:100%; padding:12px; border:1px solid #eee; border-radius:12px; margin-bottom:10px; box-sizing:border-box;">
            <input type="number" id="pQt" placeholder="Quanti?" style="width:100%; padding:12px; border:1px solid #eee; border-radius:12px; margin-bottom:10px; box-sizing:border-box;">
            <button class="btn-main" onclick="aggiungiDispensa()">AGGIUNGI</button>
            <button id="btn-annulla-disp" style="display:none; width:100%; background:none; color:var(--danger); margin-top:10px" onclick="resetDispEditor()">Annulla</button>
        </div>
        <div id="elencoDispensa"></div>
    </div>

    <div id="ricette" class="page">
        <h3 id="ric-title" style="margin-left:5px;">üìñ Le mie Ricette</h3>
        <div class="card">
            <input type="text" id="rNome" placeholder="Nome Piatto" style="width:100%; padding:12px; border:1px solid #eee; border-radius:12px; margin-bottom:10px; box-sizing:border-box;">
            <div style="display:flex; gap:8px;">
                <input type="text" id="ingN" placeholder="Ingrediente" style="flex:2; padding:12px; border:1px solid #eee; border-radius:12px; box-sizing:border-box;">
                <input type="number" id="ingQ" placeholder="Qt" style="flex:1; padding:12px; border:1px solid #eee; border-radius:12px; box-sizing:border-box;">
                <button onclick="addIng()" style="background:var(--primary); color:white; width:45px; border-radius:12px;">+</button>
            </div>
            <div id="listaTemp" style="margin:15px 0;"></div>
            <button class="btn-main" onclick="salvaRicetta()">SALVA RICETTA</button>
            <button id="btn-annulla-ric" style="display:none; width:100%; background:none; color:var(--danger); margin-top:10px" onclick="resetRicEditor()">Annulla</button>
        </div>
        <div id="elencoRicette"></div>
    </div>

    <nav class="tab-bar">
        <button class="tab-btn active" onclick="cambiaPagina('home', this)">Piani</button>
        <button class="tab-btn" onclick="cambiaPagina('dispensa', this)">Scorte</button>
        <button class="tab-btn" onclick="cambiaPagina('ricette', this)">Piatti</button>
    </nav>
</div>

<script>
    const SB_URL = "https://cpvtgadcyjpsvseflwdi.supabase.co";
    const SB_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImNwdnRnYWRjeWpwc3ZzZWZsd2RpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NzE3Njc3NDAsImV4cCI6MjA4NzM0Mzc0MH0._oU5ucMpMc3Yku4ADpDQgRHuljVMX-Bs_ulyYA3mvKI";
    const _supabase = supabase.createClient(SB_URL, SB_KEY);

    let dbData = { dispensa: {}, ricette: [], piano: {} };
    let ingTemp = [];
    let editIdx = -1;

    async function checkUser() {
        const { data } = await _supabase.auth.getSession();
        if (data?.session) showApp();
    }

    async function handleLogin() {
        const e = document.getElementById('email').value;
        const p = document.getElementById('password').value;
        const { error } = await _supabase.auth.signInWithPassword({ email: e, password: p });
        if (error) alert("Credenziali errate"); else showApp();
    }

    function handleLogout() { _supabase.auth.signOut(); location.reload(); }

    function showApp() {
        document.getElementById('login-page').style.display = 'none';
        document.getElementById('app-content').style.display = 'block';
        fetchData();
    }

    async function fetchData() {
        const { data } = await _supabase.from('casa_data').select('*');
        if (data) data.forEach(r => { dbData[r.data_type] = r.content; });
        render();
    }

    async function sync(t) {
    const { error } = await _supabase.from('casa_data').upsert(
        { 
            data_type: t, 
            content: dbData[t] 
        }, 
        { onConflict: 'data_type' } // FONDAMENTALE: aggiorna la riga indipendentemente dall'utente
    );

    if (error) {
        console.error("Errore di salvataggio:", error);
        alert("Attenzione: Modifica non salvata nel database!");
    } else {
        render();
    }
}

    window.compra = function(k, d, q) {
        if (!dbData.dispensa[k]) dbData.dispensa[k] = { q: q, display: d };
        else dbData.dispensa[k].q += q;
        sync('dispensa');
    };

    function aggiungiDispensa() {
        const n = document.getElementById('pNome').value.trim();
        const q = parseInt(document.getElementById('pQt').value);
        if(!n || isNaN(q)) return;
        const k = n.toLowerCase();
        if(dbData.dispensa[k]) {
            if(confirm("Sommare alla scorta esistente?")) dbData.dispensa[k].q += q;
            else dbData.dispensa[k].q = q;
        } else { dbData.dispensa[k] = { q: q, display: n }; }
        resetDispEditor(); sync('dispensa');
    }

    function editProd(k) {
        document.getElementById('pNome').value = dbData.dispensa[k].display;
        document.getElementById('pQt').value = dbData.dispensa[k].q;
        document.getElementById('disp-title').innerText = "üìù Modifica";
        document.getElementById('btn-annulla-disp').style.display = "block";
    }

    function resetDispEditor() {
        document.getElementById('pNome').value = ""; document.getElementById('pQt').value = "";
        document.getElementById('disp-title').innerText = "üì¶ Dispensa";
        document.getElementById('btn-annulla-disp').style.display = "none";
    }

    function addIng() {
        const n = document.getElementById('ingN').value.trim();
        const q = parseInt(document.getElementById('ingQ').value);
        if(n && q) { 
            ingTemp.push({ n: n.toLowerCase(), q: q, display: n }); 
            document.getElementById('ingN').value = "";
            document.getElementById('ingQ').value = "";
            renderIngs(); 
        }
    }

    function renderIngs() {
        document.getElementById('listaTemp').innerHTML = ingTemp.map((i, x) => `
            <div style="font-size:12px; background:#f8f9fa; padding:8px; border-radius:8px; margin-bottom:5px; display:flex; justify-content:space-between; align-items:center;">
                <span>${i.display} (<b>${i.q}</b>)</span> 
                <span onclick="ingTemp.splice(${x},1);renderIngs()" style="color:red; font-weight:bold; padding:0 5px;">‚úï</span>
            </div>`).join('');
    }

    function salvaRicetta() {
        const n = document.getElementById('rNome').value.trim();
        if(!n || ingTemp.length === 0) return;
        const r = { nome: n, ingredienti: [...ingTemp] };
        if(editIdx > -1) dbData.ricette[editIdx] = r; else dbData.ricette.push(r);
        resetRicEditor(); sync('ricette');
    }

    function editRic(i) {
        editIdx = i; const r = dbData.ricette[i];
        document.getElementById('rNome').value = r.nome;
        ingTemp = [...r.ingredienti]; renderIngs();
        document.getElementById('ric-title').innerText = "üìù Modifica Ricetta";
        document.getElementById('btn-annulla-ric').style.display = "block";
    }

    function resetRicEditor() {
        editIdx = -1; ingTemp = []; renderIngs();
        document.getElementById('rNome').value = "";
        document.getElementById('ric-title').innerText = "üìñ Le mie Ricette";
        document.getElementById('btn-annulla-ric').style.display = "none";
    }

    function cucina(idChiave) {
        const r = dbData.ricette.find(x => x.nome === dbData.piano[idChiave]);
        if(!r || !confirm("Hai cucinato " + r.nome + "? Sconter√≤ gli ingredienti.")) return;
        r.ingredienti.forEach(i => {
            if(dbData.dispensa[i.n]) dbData.dispensa[i.n].q = Math.max(0, dbData.dispensa[i.n].q - i.q);
        });
        dbData.piano[idChiave] = ""; sync('dispensa'); sync('piano');
    }

    function render() {
        const gs = ["Lun", "Mar", "Mer", "Gio", "Ven", "Sab", "Dom"];
        let f = new Date().getDate() - (new Date().getDay() === 0 ? 6 : new Date().getDay() - 1);
        let hS = ""; let dS = [];
        
        for(let i=0; i<7; i++) {
            let d = new Date(new Date().setDate(f+i));
            let s = d.toDateString(); dS.push(s);
            
            hS += `<div class="day-box ${new Date().toDateString() === s ? 'today' : ''}">
                <div class="day-title">${gs[i]} ${d.getDate()}</div>
                
                <div class="meal-row">
                    <div class="meal-label label-p">‚òÄÔ∏è PRANZO</div>
                    <select onchange="dbData.piano['${s}_p']=this.value;sync('piano')">
                        <option value="">-</option>
                        ${dbData.ricette.map(r => `<option value="${r.nome}" ${dbData.piano[s+'_p']===r.nome?'selected':''}>${r.nome}</option>`).join('')}
                    </select>
                    ${dbData.piano[s+'_p'] ? `<div class="btn-cook" onclick="cucina('${s}_p')">ü•ò</div>` : ''}
                </div>

                <div class="meal-row" style="margin-bottom:0;">
                    <div class="meal-label label-c">üåô CENA</div>
                    <select onchange="dbData.piano['${s}_c']=this.value;sync('piano')">
                        <option value="">-</option>
                        ${dbData.ricette.map(r => `<option value="${r.nome}" ${dbData.piano[s+'_c']===r.nome?'selected':''}>${r.nome}</option>`).join('')}
                    </select>
                    ${dbData.piano[s+'_c'] ? `<div class="btn-cook" onclick="cucina('${s}_c')">ü•ò</div>` : ''}
                </div>
            </div>`;
        }
        document.getElementById('settimana').innerHTML = hS;

        let fab = {};
        dS.forEach(s => {
            ['_p', '_c'].forEach(tipo => {
                let r = dbData.ricette.find(y => y.nome === dbData.piano[s + tipo]);
                if(r) r.ingredienti.forEach(i => {
                    if(!fab[i.n]) fab[i.n] = { q: 0, d: i.display };
                    fab[i.n].q += i.q;
                });
            });
        });

        let hSp = "";
        for(let k in fab) {
            let inDisp = dbData.dispensa[k]?.q || 0;
            if(inDisp < fab[k].q) {
                let diff = fab[k].q - inDisp;
                hSp += `<div class="item-row">
                    <span style="font-size:14px;">${fab[k].d} <b style="color:var(--danger)">x${diff}</b></span>
                    <button class="btn-buy" onclick="window.compra('${k}', '${fab[k].d.replace(/'/g, "\\'")}', ${diff})">PRESO</button>
                </div>`;
            }
        }
        document.getElementById('listaSpesa').innerHTML = hSp || "<p style='text-align:center; color:var(--success); font-size:13px; font-weight:bold;'>Siete pronti per la settimana! ‚úÖ</p>";

        document.getElementById('elencoDispensa').innerHTML = Object.keys(dbData.dispensa).map(k => `
            <div class="clickable-item" onclick="editProd('${k}')">
                <span style="font-weight:600;">${dbData.dispensa[k].display}</span>
                <div style="display:flex; align-items:center; gap:12px">
                    <span class="badge">${dbData.dispensa[k].q}</span>
                    <span onclick="event.stopPropagation();if(confirm('Elimino?')) {delete dbData.dispensa['${k}'];sync('dispensa');}" style="color:#dadce0; font-size:18px;">‚úï</span>
                </div>
            </div>`).join('');

        document.getElementById('elencoRicette').innerHTML = dbData.ricette.map((r, i) => `
            <div class="clickable-item" onclick="editRic(${i})">
                <span style="font-weight:600;">${r.nome}</span>
                <span onclick="event.stopPropagation();if(confirm('Elimino la ricetta?')) {dbData.ricette.splice(${i},1);sync('ricette');}" style="color:#dadce0; font-size:18px;">‚úï</span>
            </div>`).join('');
    }

    function cambiaPagina(id, btn) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        document.getElementById(id).classList.add('active'); btn.classList.add('active');
        window.scrollTo(0,0);
    }

    checkUser();
</script>
</body>
</html>

